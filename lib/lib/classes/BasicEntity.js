"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.BasicEntity = void 0;
const joi_1 = __importDefault(require("joi"));
const lodash_1 = __importDefault(require("lodash"));
const decorators_1 = require("../decorators");
class BasicEntity {
    // ---------------- BASIC ATTRIBUTES SETTINGS ----------------
    constructor(item = {}) {
        this._attributes = {};
        this.attributes = item;
        this.getAttribute = this.getAttribute.bind(this);
        this.setAttribute = this.setAttribute.bind(this);
    }
    get attributes() {
        return this._attributes || {};
    }
    set attributes(attributes) {
        // WE SHOULD ORGANIZE THE ENTRIES ORDER SO IT SETS THE CHILD PROPERTIES BEFORE SETTING THE REST (SO IT DOES NOT OVERWRITE)
        const entries = Object.entries(attributes);
        const hasOneModels = (0, decorators_1.getHasOneModels)(this) || [];
        const hasManyModels = (0, decorators_1.getHasManyModels)(this) || [];
        const allModels = hasOneModels.concat(hasManyModels);
        entries.sort(([aKey], [bKey]) => {
            if (allModels.includes(aKey) && !allModels.includes(bKey))
                return -1;
            if (!allModels.includes(aKey) && allModels.includes(bKey))
                return 1;
            return 0;
        });
        for (const [key, value] of entries) {
            (0, decorators_1.setPropGettersAndSetters)(this.constructor.prototype, key);
            this[key] = value;
        }
    }
    getAttribute(key) {
        return this.attributes[key];
    }
    setAttribute(key, value) {
        this.attributes[key] = value;
    }
    get enumerableAttributes() {
        return Object.keys(this.constructor.prototype).reduce((agg, key) => {
            let value;
            if (this.relatedNotNestedModels.includes(key)) {
                value = this[`_noInitializer${lodash_1.default.capitalize(key)}`];
            }
            else {
                value = this[key];
            }
            if (value !== undefined)
                agg[key] = value;
            return agg;
        }, {});
    }
    get transformedAttributes() {
        let attributes = (0, decorators_1.transformAliasAttributes)(this, this.enumerableAttributes);
        attributes = (0, decorators_1.transformHasManyAttributes)(this, attributes);
        attributes = (0, decorators_1.transformHasOneAttributes)(this, attributes);
        attributes = (0, decorators_1.transformCompositeKeyAttributes)(this, attributes);
        return attributes;
    }
    get validatedAttributes() {
        return (0, decorators_1.validateAttributes)(this, this.transformedAttributes);
    }
    get finalAttributes() {
        return this.validatedAttributes;
    }
    // ---------------- BASIC ATTRIBUTES SETTINGS ----------------
    // ---------------- VALIDATION SUPPORT SETTINGS ----------------
    get relatedNotNestedModels() {
        return (0, decorators_1.getHasOneNotNestedModels)(this).concat((0, decorators_1.getHasManyNotNestedModels)(this));
    }
    validateRelatedModels(_throw = false) {
        for (const hasOneModel of (0, decorators_1.getHasOneNotNestedModels)(this)) {
            const instance = this[`_noInitializer${lodash_1.default.capitalize(hasOneModel)}`];
            if (instance == null) {
                const { opts: { required = false, } = {}, } = (0, decorators_1.getHasOneModel)(this, hasOneModel) || {};
                if (required) {
                    const error = new joi_1.default.ValidationError(`"${hasOneModel}" is required.`, this, this.attributes);
                    if (_throw) {
                        throw error;
                    }
                    else {
                        this._error = error;
                        return false;
                    }
                }
                else {
                    continue;
                }
            }
            const valid = instance.validate(_throw);
            if (!valid) {
                this._error = instance.error;
                return false;
            }
        }
        return true;
    }
    validate(_throw = false) {
        this._error = undefined;
        try {
            (0, decorators_1.validateAttributes)(this, this.transformedAttributes);
            this.validateRelatedModels(true);
            return true;
        }
        catch (error) {
            if (_throw) {
                throw error;
            }
            else if (error instanceof joi_1.default.ValidationError) {
                this._error = error;
                return false;
            }
            throw error;
        }
    }
    get valid() {
        return this.validate();
    }
    get error() {
        return this._error;
    }
    // ---------------- VALIDATION SETTINGS ----------------
    // ---------------- STATIC METHODS ----------------
    static transformAttributes(item) {
        return new this(item).transformedAttributes;
    }
    static validateAttributes(item) {
        return new this(item).validatedAttributes;
    }
    static validate(item, _throw = true) {
        return new this(item).validate(_throw);
    }
}
exports.BasicEntity = BasicEntity;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmFzaWNFbnRpdHkuanMiLCJzb3VyY2VSb290IjoiLyIsInNvdXJjZXMiOlsibGliL2NsYXNzZXMvQmFzaWNFbnRpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsOENBQXNCO0FBQ3RCLG9EQUF1QjtBQUN2Qiw4Q0FZdUI7QUFFdkIsTUFBYSxXQUFXO0lBS3RCLDhEQUE4RDtJQUU5RCxZQUFZLE9BQTRCLEVBQUU7UUFOaEMsZ0JBQVcsR0FBd0IsRUFBRSxDQUFDO1FBTzlDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBRXZCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakQsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRUQsSUFBSSxVQUFVO1FBQ1osT0FBTyxJQUFJLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQztJQUNoQyxDQUFDO0lBRUQsSUFBSSxVQUFVLENBQUMsVUFBK0I7UUFDNUMsMEhBQTBIO1FBQzFILE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDM0MsTUFBTSxZQUFZLEdBQUcsSUFBQSw0QkFBZSxFQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNqRCxNQUFNLGFBQWEsR0FBRyxJQUFBLDZCQUFnQixFQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNuRCxNQUFNLFNBQVMsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3JELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUM5QixJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxT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LGVBQWUsRUFBRTtnQkFDL0MsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7Z0JBQ3BCLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7WUFFRCxNQUFNLEtBQUssQ0FBQztTQUNiO0lBQ0gsQ0FBQztJQUVELElBQUksS0FBSztRQUNQLE9BQU8sSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFFRCxJQUFJLEtBQUs7UUFDUCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDckIsQ0FBQztJQUVELHdEQUF3RDtJQUV4RCxtREFBbUQ7SUFFbkQsTUFBTSxDQUFDLG1CQUFtQixDQUFDLElBQXlCO1FBQ2xELE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMscUJBQXFCLENBQUM7SUFDOUMsQ0FBQztJQUVELE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxJQUF5QjtRQUNqRCxPQUFPLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLG1CQUFtQixDQUFDO0lBQzVDLENBQUM7SUFFRCxNQUFNLENBQUMsUUFBUSxDQUFDLElBQXlCLEVBQUUsU0FBa0IsSUFBSTtRQUMvRCxPQUFPLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN6QyxDQUFDO0NBR0Y7QUF0S0Qsa0NBc0tDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEpvaSBmcm9tICdqb2knO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7XG4gIGdldEhhc01hbnlNb2RlbHMsXG4gIGdldEhhc01hbnlOb3ROZXN0ZWRNb2RlbHMsXG4gIGdldEhhc09uZU1vZGVsLFxuICBnZXRIYXNPbmVNb2RlbHMsXG4gIGdldEhhc09uZU5vdE5lc3RlZE1vZGVscyxcbiAgc2V0UHJvcEdldHRlcnNBbmRTZXR0ZXJzLFxuICB0cmFuc2Zvcm1BbGlhc0F0dHJpYnV0ZXMsXG4gIHRyYW5zZm9ybUNvbXBvc2l0ZUtleUF0dHJpYnV0ZXMsXG4gIHRyYW5zZm9ybUhhc01hbnlBdHRyaWJ1dGVzLFxuICB0cmFuc2Zvcm1IYXNPbmVBdHRyaWJ1dGVzLFxuICB2YWxpZGF0ZUF0dHJpYnV0ZXMsXG59IGZyb20gJy4uL2RlY29yYXRvcnMnO1xuXG5leHBvcnQgY2xhc3MgQmFzaWNFbnRpdHkge1xuICBwcm90ZWN0ZWQgX2F0dHJpYnV0ZXM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcblxuICBba2V5OiBzdHJpbmddOiBhbnk7XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLSBCQVNJQyBBVFRSSUJVVEVTIFNFVFRJTkdTIC0tLS0tLS0tLS0tLS0tLS1cblxuICBjb25zdHJ1Y3RvcihpdGVtOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge30pIHtcbiAgICB0aGlzLmF0dHJpYnV0ZXMgPSBpdGVtO1xuXG4gICAgdGhpcy5nZXRBdHRyaWJ1dGUgPSB0aGlzLmdldEF0dHJpYnV0ZS5iaW5kKHRoaXMpO1xuICAgIHRoaXMuc2V0QXR0cmlidXRlID0gdGhpcy5zZXRBdHRyaWJ1dGUuYmluZCh0aGlzKTtcbiAgfVxuXG4gIGdldCBhdHRyaWJ1dGVzKCk6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIHJldHVybiB0aGlzLl9hdHRyaWJ1dGVzIHx8IHt9O1xuICB9XG5cbiAgc2V0IGF0dHJpYnV0ZXMoYXR0cmlidXRlczogUmVjb3JkPHN0cmluZywgYW55Pikge1xuICAgIC8vIFdFIFNIT1VMRCBPUkdBTklaRSBUSEUgRU5UUklFUyBPUkRFUiBTTyBJVCBTRVRTIFRIRSBDSElMRCBQUk9QRVJUSUVTIEJFRk9SRSBTRVRUSU5HIFRIRSBSRVNUIChTTyBJVCBET0VTIE5PVCBPVkVSV1JJVEUpXG4gICAgY29uc3QgZW50cmllcyA9IE9iamVjdC5lbnRyaWVzKGF0dHJpYnV0ZXMpO1xuICAgIGNvbnN0IGhhc09uZU1vZGVscyA9IGdldEhhc09uZU1vZGVscyh0aGlzKSB8fCBbXTtcbiAgICBjb25zdCBoYXNNYW55TW9kZWxzID0gZ2V0SGFzTWFueU1vZGVscyh0aGlzKSB8fCBbXTtcbiAgICBjb25zdCBhbGxNb2RlbHMgPSBoYXNPbmVNb2RlbHMuY29uY2F0KGhhc01hbnlNb2RlbHMpO1xuICAgIGVudHJpZXMuc29ydCgoW2FLZXldLCBbYktleV0pID0+IHtcbiAgICAgIGlmIChhbGxNb2RlbHMuaW5jbHVkZXMoYUtleSkgJiYgIWFsbE1vZGVscy5pbmNsdWRlcyhiS2V5KSkgcmV0dXJuIC0xO1xuICAgICAgaWYgKCFhbGxNb2RlbHMuaW5jbHVkZXMoYUtleSkgJiYgYWxsTW9kZWxzLmluY2x1ZGVzKGJLZXkpKSByZXR1cm4gMTtcbiAgICAgIHJldHVybiAwO1xuICAgIH0pO1xuXG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgZW50cmllcykge1xuICAgICAgc2V0UHJvcEdldHRlcnNBbmRTZXR0ZXJzKHRoaXMuY29uc3RydWN0b3IucHJvdG90eXBlLCBrZXkpO1xuICAgICAgdGhpc1trZXldID0gdmFsdWU7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGdldEF0dHJpYnV0ZShrZXk6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlc1trZXldO1xuICB9XG5cbiAgcHJvdGVjdGVkIHNldEF0dHJpYnV0ZShrZXk6IHN0cmluZywgdmFsdWU6IGFueSk6IHZvaWQge1xuICAgIHRoaXMuYXR0cmlidXRlc1trZXldID0gdmFsdWU7XG4gIH1cblxuICBnZXQgZW51bWVyYWJsZUF0dHJpYnV0ZXMoKTogUmVjb3JkPHN0cmluZywgYW55PiB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuY29uc3RydWN0b3IucHJvdG90eXBlKS5yZWR1Y2UoKGFnZywga2V5KSA9PiB7XG4gICAgICBsZXQgdmFsdWU7XG4gICAgICBpZiAodGhpcy5yZWxhdGVkTm90TmVzdGVkTW9kZWxzLmluY2x1ZGVzKGtleSkpIHtcbiAgICAgICAgdmFsdWUgPSB0aGlzW2Bfbm9Jbml0aWFsaXplciR7Xy5jYXBpdGFsaXplKGtleSl9YF07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YWx1ZSA9IHRoaXNba2V5XTtcbiAgICAgIH1cblxuICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIGFnZ1trZXldID0gdmFsdWU7XG4gICAgICByZXR1cm4gYWdnO1xuICAgIH0sIHt9IGFzIFJlY29yZDxzdHJpbmcsIGFueT4pO1xuICB9XG5cbiAgZ2V0IHRyYW5zZm9ybWVkQXR0cmlidXRlcygpOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICBsZXQgYXR0cmlidXRlcyA9IHRyYW5zZm9ybUFsaWFzQXR0cmlidXRlcyh0aGlzLCB0aGlzLmVudW1lcmFibGVBdHRyaWJ1dGVzKTtcbiAgICBhdHRyaWJ1dGVzID0gdHJhbnNmb3JtSGFzTWFueUF0dHJpYnV0ZXModGhpcywgYXR0cmlidXRlcyk7XG4gICAgYXR0cmlidXRlcyA9IHRyYW5zZm9ybUhhc09uZUF0dHJpYnV0ZXModGhpcywgYXR0cmlidXRlcyk7XG4gICAgYXR0cmlidXRlcyA9IHRyYW5zZm9ybUNvbXBvc2l0ZUtleUF0dHJpYnV0ZXModGhpcywgYXR0cmlidXRlcyk7XG5cbiAgICByZXR1cm4gYXR0cmlidXRlcztcbiAgfVxuXG4gIGdldCB2YWxpZGF0ZWRBdHRyaWJ1dGVzKCk6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIHJldHVybiB2YWxpZGF0ZUF0dHJpYnV0ZXModGhpcywgdGhpcy50cmFuc2Zvcm1lZEF0dHJpYnV0ZXMpO1xuICB9XG5cbiAgZ2V0IGZpbmFsQXR0cmlidXRlcygpOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICByZXR1cm4gdGhpcy52YWxpZGF0ZWRBdHRyaWJ1dGVzO1xuICB9XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLSBCQVNJQyBBVFRSSUJVVEVTIFNFVFRJTkdTIC0tLS0tLS0tLS0tLS0tLS1cblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tIFZBTElEQVRJT04gU1VQUE9SVCBTRVRUSU5HUyAtLS0tLS0tLS0tLS0tLS0tXG5cbiAgcHJvdGVjdGVkIGdldCByZWxhdGVkTm90TmVzdGVkTW9kZWxzKCkge1xuICAgIHJldHVybiBnZXRIYXNPbmVOb3ROZXN0ZWRNb2RlbHModGhpcykuY29uY2F0KGdldEhhc01hbnlOb3ROZXN0ZWRNb2RlbHModGhpcykpO1xuICB9XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLSBWQUxJREFUSU9OIFNVUFBPUlQgU0VUVElOR1MgLS0tLS0tLS0tLS0tLS0tLVxuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0gVkFMSURBVElPTiBTRVRUSU5HUyAtLS0tLS0tLS0tLS0tLS0tXG5cbiAgcHJvdGVjdGVkIF9lcnJvcjogSm9pLlZhbGlkYXRpb25FcnJvciB8IHVuZGVmaW5lZDtcblxuICB2YWxpZGF0ZVJlbGF0ZWRNb2RlbHMoX3Rocm93OiBib29sZWFuID0gZmFsc2UpOiBib29sZWFuIHtcbiAgICBmb3IgKGNvbnN0IGhhc09uZU1vZGVsIG9mIGdldEhhc09uZU5vdE5lc3RlZE1vZGVscyh0aGlzKSkge1xuICAgICAgY29uc3QgaW5zdGFuY2U6IEJhc2ljRW50aXR5IHwgdW5kZWZpbmVkID0gdGhpc1tgX25vSW5pdGlhbGl6ZXIke18uY2FwaXRhbGl6ZShoYXNPbmVNb2RlbCl9YF07XG5cbiAgICAgIGlmIChpbnN0YW5jZSA9PSBudWxsKSB7XG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICBvcHRzOiB7XG4gICAgICAgICAgICByZXF1aXJlZCA9IGZhbHNlLFxuICAgICAgICAgIH0gPSB7fSxcbiAgICAgICAgfSA9IGdldEhhc09uZU1vZGVsKHRoaXMsIGhhc09uZU1vZGVsKSB8fCB7fTtcblxuICAgICAgICBpZiAocmVxdWlyZWQpIHtcbiAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBKb2kuVmFsaWRhdGlvbkVycm9yKGBcIiR7aGFzT25lTW9kZWx9XCIgaXMgcmVxdWlyZWQuYCwgdGhpcywgdGhpcy5hdHRyaWJ1dGVzKTtcbiAgICAgICAgICBpZiAoX3Rocm93KSB7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fZXJyb3IgPSBlcnJvcjtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgdmFsaWQgPSBpbnN0YW5jZS52YWxpZGF0ZShfdGhyb3cpO1xuICAgICAgaWYgKCF2YWxpZCkge1xuICAgICAgICB0aGlzLl9lcnJvciA9IGluc3RhbmNlLmVycm9yO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICB2YWxpZGF0ZShfdGhyb3c6IGJvb2xlYW4gPSBmYWxzZSk6IGJvb2xlYW4ge1xuICAgIHRoaXMuX2Vycm9yID0gdW5kZWZpbmVkO1xuICAgIHRyeSB7XG4gICAgICB2YWxpZGF0ZUF0dHJpYnV0ZXModGhpcywgdGhpcy50cmFuc2Zvcm1lZEF0dHJpYnV0ZXMpO1xuICAgICAgdGhpcy52YWxpZGF0ZVJlbGF0ZWRNb2RlbHModHJ1ZSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKF90aHJvdykge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBKb2kuVmFsaWRhdGlvbkVycm9yKSB7XG4gICAgICAgIHRoaXMuX2Vycm9yID0gZXJyb3I7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgZ2V0IHZhbGlkKCkge1xuICAgIHJldHVybiB0aGlzLnZhbGlkYXRlKCk7XG4gIH1cblxuICBnZXQgZXJyb3IoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Vycm9yO1xuICB9XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLSBWQUxJREFUSU9OIFNFVFRJTkdTIC0tLS0tLS0tLS0tLS0tLS1cblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tIFNUQVRJQyBNRVRIT0RTIC0tLS0tLS0tLS0tLS0tLS1cblxuICBzdGF0aWMgdHJhbnNmb3JtQXR0cmlidXRlcyhpdGVtOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogUmVjb3JkPHN0cmluZywgYW55PiB7XG4gICAgcmV0dXJuIG5ldyB0aGlzKGl0ZW0pLnRyYW5zZm9ybWVkQXR0cmlidXRlcztcbiAgfVxuXG4gIHN0YXRpYyB2YWxpZGF0ZUF0dHJpYnV0ZXMoaXRlbTogUmVjb3JkPHN0cmluZywgYW55Pik6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIHJldHVybiBuZXcgdGhpcyhpdGVtKS52YWxpZGF0ZWRBdHRyaWJ1dGVzO1xuICB9XG5cbiAgc3RhdGljIHZhbGlkYXRlKGl0ZW06IFJlY29yZDxzdHJpbmcsIGFueT4sIF90aHJvdzogYm9vbGVhbiA9IHRydWUpIHtcbiAgICByZXR1cm4gbmV3IHRoaXMoaXRlbSkudmFsaWRhdGUoX3Rocm93KTtcbiAgfVxuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0gU1RBVElDIE1FVEhPRFMgLS0tLS0tLS0tLS0tLS0tLVxufVxuIl19