"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getTableDynamoDbInstance = exports.getTableName = exports.getTableProps = exports.table = exports.dynamodbDocumentClient = void 0;
require("reflect-metadata");
const aws_sdk_1 = __importDefault(require("aws-sdk"));
const isTest = process.env.JEST_WORKER_ID;
const isLocal = process.env.IS_LOCAL;
const dynamoOptions = {};
if (isTest || isLocal) {
    if (process.env.JEST_WORKER_ID) {
        dynamoOptions.endpoint = 'http://localhost:4567';
    }
    else if (process.env.IS_LOCAL) {
        dynamoOptions.endpoint = 'http://localhost:3456';
    }
    dynamoOptions.sslEnabled = false;
    dynamoOptions.region = 'local-env';
    dynamoOptions.credentials = new aws_sdk_1.default.Credentials({
        accessKeyId: '123',
        secretAccessKey: '123',
    });
}
exports.dynamodbDocumentClient = new aws_sdk_1.default.DynamoDB.DocumentClient(dynamoOptions);
const tableMetadataKey = Symbol('table');
function table(name, opts) {
    return (constructor) => {
        // CONSTRUCTOR IS ACTUALLY THE CLASS ITSELF
        if (name == null)
            throw new TypeError('Name is required in the table decorator');
        const dynamodb = (opts === null || opts === void 0 ? void 0 : opts.documentClient) || exports.dynamodbDocumentClient;
        Reflect.defineMetadata(tableMetadataKey, {
            name,
            dynamodb,
        }, constructor);
    };
}
exports.table = table;
const getTableProps = (target) => {
    return Reflect.getMetadata(tableMetadataKey, target);
};
exports.getTableProps = getTableProps;
const getTableName = (target) => {
    return (0, exports.getTableProps)(target).name;
};
exports.getTableName = getTableName;
const getTableDynamoDbInstance = (target) => {
    return (0, exports.getTableProps)(target).dynamodb;
};
exports.getTableDynamoDbInstance = getTableDynamoDbInstance;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUuanMiLCJzb3VyY2VSb290IjoiLyIsInNvdXJjZXMiOlsibGliL2RlY29yYXRvcnMvdGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNEJBQTBCO0FBQzFCLHNEQUEwQjtBQUUxQixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQztBQUMxQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQztBQUVyQyxNQUFNLGFBQWEsR0FBK0YsRUFBRSxDQUFDO0FBRXJILElBQUksTUFBTSxJQUFJLE9BQU8sRUFBRTtJQUNyQixJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFO1FBQzlCLGFBQWEsQ0FBQyxRQUFRLEdBQUcsdUJBQXVCLENBQUM7S0FDbEQ7U0FBTSxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFO1FBQy9CLGFBQWEsQ0FBQyxRQUFRLEdBQUcsdUJBQXVCLENBQUM7S0FDbEQ7SUFFRCxhQUFhLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztJQUNqQyxhQUFhLENBQUMsTUFBTSxHQUFHLFdBQVcsQ0FBQztJQUNuQyxhQUFhLENBQUMsV0FBVyxHQUFHLElBQUksaUJBQUcsQ0FBQyxXQUFXLENBQUM7UUFDOUMsV0FBVyxFQUFFLEtBQUs7UUFDbEIsZUFBZSxFQUFFLEtBQUs7S0FDdkIsQ0FBQyxDQUFDO0NBQ0o7QUFDWSxRQUFBLHNCQUFzQixHQUFHLElBQUksaUJBQUcsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBRXJGLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBTXpDLFNBQWdCLEtBQUssQ0FBQyxJQUFZLEVBQUUsSUFBYztJQUNoRCxPQUFPLENBQUMsV0FBcUIsRUFBRSxFQUFFO1FBQy9CLDJDQUEyQztRQUMzQyxJQUFJLElBQUksSUFBSSxJQUFJO1lBQUUsTUFBTSxJQUFJLFNBQVMsQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO1FBRWpGLE1BQU0sUUFBUSxHQUFHLENBQUEsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLGNBQWMsS0FBSSw4QkFBc0IsQ0FBQztRQUVoRSxPQUFPLENBQUMsY0FBYyxDQUFDLGdCQUFnQixFQUFFO1lBQ3ZDLElBQUk7WUFDSixRQUFRO1NBQ1QsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNsQixDQUFDLENBQUM7QUFDSixDQUFDO0FBWkQsc0JBWUM7QUFFTSxNQUFNLGFBQWEsR0FBRyxDQUFDLE1BQVcsRUFBMkQsRUFBRTtJQUNwRyxPQUFPLE9BQU8sQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDdkQsQ0FBQyxDQUFDO0FBRlcsUUFBQSxhQUFhLGlCQUV4QjtBQUVLLE1BQU0sWUFBWSxHQUFHLENBQUMsTUFBVyxFQUFVLEVBQUU7SUFDbEQsT0FBTyxJQUFBLHFCQUFhLEVBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ3BDLENBQUMsQ0FBQztBQUZXLFFBQUEsWUFBWSxnQkFFdkI7QUFFSyxNQUFNLHdCQUF3QixHQUFHLENBQUMsTUFBVyxFQUErQixFQUFFO0lBQ25GLE9BQU8sSUFBQSxxQkFBYSxFQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsQ0FBQztBQUN4QyxDQUFDLENBQUM7QUFGVyxRQUFBLHdCQUF3Qiw0QkFFbkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ3JlZmxlY3QtbWV0YWRhdGEnO1xuaW1wb3J0IEFXUyBmcm9tICdhd3Mtc2RrJztcblxuY29uc3QgaXNUZXN0ID0gcHJvY2Vzcy5lbnYuSkVTVF9XT1JLRVJfSUQ7XG5jb25zdCBpc0xvY2FsID0gcHJvY2Vzcy5lbnYuSVNfTE9DQUw7XG5cbmNvbnN0IGR5bmFtb09wdGlvbnM6IEFXUy5EeW5hbW9EQi5Eb2N1bWVudENsaWVudC5Eb2N1bWVudENsaWVudE9wdGlvbnMgJiBBV1MuRHluYW1vREIuVHlwZXMuQ2xpZW50Q29uZmlndXJhdGlvbiA9IHt9O1xuXG5pZiAoaXNUZXN0IHx8IGlzTG9jYWwpIHtcbiAgaWYgKHByb2Nlc3MuZW52LkpFU1RfV09SS0VSX0lEKSB7XG4gICAgZHluYW1vT3B0aW9ucy5lbmRwb2ludCA9ICdodHRwOi8vbG9jYWxob3N0OjQ1NjcnO1xuICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52LklTX0xPQ0FMKSB7XG4gICAgZHluYW1vT3B0aW9ucy5lbmRwb2ludCA9ICdodHRwOi8vbG9jYWxob3N0OjM0NTYnO1xuICB9XG5cbiAgZHluYW1vT3B0aW9ucy5zc2xFbmFibGVkID0gZmFsc2U7XG4gIGR5bmFtb09wdGlvbnMucmVnaW9uID0gJ2xvY2FsLWVudic7XG4gIGR5bmFtb09wdGlvbnMuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHtcbiAgICBhY2Nlc3NLZXlJZDogJzEyMycsXG4gICAgc2VjcmV0QWNjZXNzS2V5OiAnMTIzJyxcbiAgfSk7XG59XG5leHBvcnQgY29uc3QgZHluYW1vZGJEb2N1bWVudENsaWVudCA9IG5ldyBBV1MuRHluYW1vREIuRG9jdW1lbnRDbGllbnQoZHluYW1vT3B0aW9ucyk7XG5cbmNvbnN0IHRhYmxlTWV0YWRhdGFLZXkgPSBTeW1ib2woJ3RhYmxlJyk7XG5cbnR5cGUgT3B0aW9ucyA9IHtcbiAgZG9jdW1lbnRDbGllbnQ/OiBBV1MuRHluYW1vREIuRG9jdW1lbnRDbGllbnQ7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gdGFibGUobmFtZTogc3RyaW5nLCBvcHRzPzogT3B0aW9ucykge1xuICByZXR1cm4gKGNvbnN0cnVjdG9yOiBGdW5jdGlvbikgPT4ge1xuICAgIC8vIENPTlNUUlVDVE9SIElTIEFDVFVBTExZIFRIRSBDTEFTUyBJVFNFTEZcbiAgICBpZiAobmFtZSA9PSBudWxsKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdOYW1lIGlzIHJlcXVpcmVkIGluIHRoZSB0YWJsZSBkZWNvcmF0b3InKTtcblxuICAgIGNvbnN0IGR5bmFtb2RiID0gb3B0cz8uZG9jdW1lbnRDbGllbnQgfHwgZHluYW1vZGJEb2N1bWVudENsaWVudDtcblxuICAgIFJlZmxlY3QuZGVmaW5lTWV0YWRhdGEodGFibGVNZXRhZGF0YUtleSwge1xuICAgICAgbmFtZSxcbiAgICAgIGR5bmFtb2RiLFxuICAgIH0sIGNvbnN0cnVjdG9yKTtcbiAgfTtcbn1cblxuZXhwb3J0IGNvbnN0IGdldFRhYmxlUHJvcHMgPSAodGFyZ2V0OiBhbnkpOiB7IG5hbWU6IHN0cmluZywgZHluYW1vZGI6IEFXUy5EeW5hbW9EQi5Eb2N1bWVudENsaWVudCB9ID0+IHtcbiAgcmV0dXJuIFJlZmxlY3QuZ2V0TWV0YWRhdGEodGFibGVNZXRhZGF0YUtleSwgdGFyZ2V0KTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRUYWJsZU5hbWUgPSAodGFyZ2V0OiBhbnkpOiBzdHJpbmcgPT4ge1xuICByZXR1cm4gZ2V0VGFibGVQcm9wcyh0YXJnZXQpLm5hbWU7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0VGFibGVEeW5hbW9EYkluc3RhbmNlID0gKHRhcmdldDogYW55KTogQVdTLkR5bmFtb0RCLkRvY3VtZW50Q2xpZW50ID0+IHtcbiAgcmV0dXJuIGdldFRhYmxlUHJvcHModGFyZ2V0KS5keW5hbW9kYjtcbn07XG4iXX0=